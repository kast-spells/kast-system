{{/*kast - Kubernetes arcane spelling technology
Copyright (C) 2023 namenmalkv@gmail.com
Licensed under the GNU GPL v3. See LICENSE file for details.

Covenant ApplicationSet Generator
Generates an ApplicationSet that creates a covenant instance per chapter
Only renders if covenant.chapterFilter is NOT set (main covenant instance)
*/}}

{{- $root := . }}
{{- $covenant := .Values.covenant }}

{{/* Only generate ApplicationSet if we're in "main" mode (no chapterFilter) */}}
{{- if not $covenant.chapterFilter }}

{{/* Use .Values.name (from librarian) as bookPath */}}
{{- $bookPath := default .Release.Name .Values.name }}

{{/* Scan bookrack to find all chapters with members */}}
{{- $chaptersWithMembers := list }}
{{- $covenantIndexPath := printf "bookrack/%s/index.yaml" $bookPath }}

{{- if .Files.Glob $covenantIndexPath }}

{{/* Scan for chapters - try new structure first (covenant/ subdir), fallback to old */}}
{{- $chapterIndexGlob := printf "bookrack/%s/covenant/*/index.yaml" $bookPath }}
{{- if not (.Files.Glob $chapterIndexGlob) }}
  {{- $chapterIndexGlob = printf "bookrack/%s/*/index.yaml" $bookPath }}
{{- end }}

{{- range $chapterPath, $_ := .Files.Glob $chapterIndexGlob }}
  {{- $chapterName := base (dir $chapterPath) }}

  {{/* Skip conventions, realm, and covenant directories */}}
  {{- if and (ne $chapterName "conventions") (ne $chapterName "realm") (ne $chapterName "covenant") }}
    {{/* Check if chapter has member files - try new structure first */}}
    {{- $memberGlob := printf "bookrack/%s/covenant/%s/*/*.yaml" $bookPath $chapterName }}
    {{- if not ($.Files.Glob $memberGlob) }}
      {{- $memberGlob = printf "bookrack/%s/%s/*/*.yaml" $bookPath $chapterName }}
    {{- end }}
    {{- if $.Files.Glob $memberGlob }}
      {{- $chaptersWithMembers = append $chaptersWithMembers $chapterName }}
    {{- end }}
  {{- end }}
{{- end }}

{{/* If we found chapters with members AND trinkets available, generate ApplicationSet */}}
{{- if and $chaptersWithMembers .Values.spellbook.trinkets }}

{{/* Get covenant trinket definition from spellbook */}}
{{- $covenantTrinket := get .Values.spellbook.trinkets "covenant" }}
{{- if not $covenantTrinket }}
  {{- fail "covenant trinket not found in spellbook.trinkets - ensure covenant is registered in book index.yaml" }}
{{- end }}
{{- $repoURL := required "covenant trinket repository is required" $covenantTrinket.repository }}
{{- $path := required "covenant trinket path is required" $covenantTrinket.path }}
{{- $revision := required "covenant trinket revision is required" $covenantTrinket.revision }}

{{/* Use runicIndexer to find Keycloak instance from lexicon */}}
{{- $chapterName := "" }}
{{- $chapterLabels := dict }}
{{- if $root.Values.chapter }}
  {{- $chapterName = $root.Values.chapter.name }}
  {{- $chapterLabels = dict "chapter" $chapterName }}
{{- end }}
{{- $keycloakInstances := get (include "runicIndexer.runicIndexer" (list $root.Values.lexicon $chapterLabels "keycloak" $chapterName) | fromJson) "results" }}
{{- $keycloakInstance := dict }}
{{- range $keycloakInstances }}
  {{- $keycloakInstance = . }}
{{- end }}
---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: {{ $bookPath }}-chapters
  namespace: {{ default "argocd" .Values.spellbook.argocdNamespace }}
  labels:
    app.kubernetes.io/name: {{ $bookPath }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    covenant.kast.io/type: applicationset
  annotations:
    argocd.argoproj.io/sync-wave: "{{ default "6" ($covenant.appParams).syncWave }}"
spec:
  goTemplate: true

  generators:
    - list:
        elements:
        {{- range $chapterName := $chaptersWithMembers }}
        - chapter: {{ $chapterName }}
        {{- end }}

  template:
    metadata:
      name: '{{ $bookPath }}-{{`{{.chapter}}`}}'
      namespace: {{ default "argocd" .Values.spellbook.argocdNamespace }}
      labels:
        app.kubernetes.io/managed-by: applicationset
        covenant.kast.io/book: {{ $bookPath }}
        covenant.kast.io/chapter: '{{`{{.chapter}}`}}'
      {{- $appParams := default dict .Values.appParams }}
      {{- with $appParams.annotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}

    spec:
      project: {{ default .Values.spellbook.name (.Values.spellbook).projectName }}

      sources:
        # Covenant chart source
        - repoURL: {{ $repoURL }}
          path: {{ $path }}
          targetRevision: {{ $revision }}
          helm:
            values: |
              name: {{ $bookPath }}-{{`{{.chapter}}`}}
              namespace: {{ printf "%s-{{.chapter}}" $bookPath }}

              covenant:
                chapterFilter: {{`{{.chapter}}`}}

              {{/* Always pass complete book context to chapter apps - they need lexicon for runicIndexer */}}
              {{- $cleanSpellbook := dict }}
              {{- $_ := set $cleanSpellbook "spellbook" (deepCopy .Values.spellbook) }}
              {{- $_ := unset $cleanSpellbook.spellbook "appParams" }}
              {{- toYaml $cleanSpellbook | nindent 14 }}

              chapter:
                {{- toYaml .Values.chapter | nindent 16 }}

              lexicon:
                {{- toYaml .Values.lexicon | nindent 16 }}

              {{- if .Values.cards }}
              cards:
                {{- toYaml .Values.cards | nindent 16 }}
              {{- end }}

      destination:
        server: https://kubernetes.default.svc
        namespace: {{ printf "%s-{{.chapter}}" $bookPath }}

      syncPolicy:
        {{- $appParams := default dict .Values.appParams }}
        {{- if $appParams.managedNamespaceMetadata }}
          {{- with $appParams.managedNamespaceMetadata }}
        managedNamespaceMetadata:
          {{- toYaml . | nindent 10 }}
          {{- end }}
        {{- end }}
        {{- if not $appParams.disableAutoSync }}
          {{- with ($appParams.syncPolicy).automated }}
        automated:
          {{- toYaml . | nindent 10 }}
          {{- end }}
        {{- end }}
        {{- with ($appParams.syncPolicy).syncOptions }}
        syncOptions:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        {{- with ($appParams.syncPolicy).retry }}
        retry:
          {{- toYaml . | nindent 10 }}
        {{- end }}
{{- end }}
{{- end }}
{{- end }}
