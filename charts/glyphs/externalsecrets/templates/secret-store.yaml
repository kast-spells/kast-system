{{/*kast - Kubernetes arcane spelling technology
Copyright (C) 2025 laaledesiempre@disroot.org
Licensed under the GNU GPL v3. See LICENSE file for details.
*/}}
{{- define "externalsecrets.secret-store" }}
{{- $root := index . 0 -}}
{{- $glyphDefinition := index . 1}}
{{- $vaultServer := get (include "runicIndexer.runicIndexer" (list $root.Values.lexicon (default dict $glyphDefinition.selector) "vault" $root.Values.chapter.name ) | fromJson) "results" }}
---
apiVersion: external-secrets.io/v1alpha1
kind: SecretStore
metadata:
  name: {{ default (include "common.name" $root ) $glyphDefinition.name }}
spec:
  provider:
    {{- if $glyphDefinition.provider.vault }}
    vault:
      version: v2
      server: {{ default $vaultServer.url $glyphDefinition.provider.vault.server }}
      path: {{ default $vaultServer.secretPath $glyphDefinition.provider.vault.path }} #este viene del lexicon de vault
      auth:
        {{- if $glyphDefinition.provider.vault.auth.tokenSecretRef }}
        tokenSecretRef:
          key: {{ $glyphDefinition.provider.vault.auth.tokenSecretRef.key }}
          name: {{ $glyphDefinition.provider.vault.auth.tokenSecretRef.name }}
          namespace: {{ $glyphDefinition.provider.vault.auth.tokenSecretRef.namespace }}
        {{- end }}


        {{- if $glyphDefinition.provider.vault.auth.kubernetes }}
        kubernetes:
          mountPath: {{ default "kubernetes" $glyphDefinition.provider.vault.auth.kubernetes.mountPath }}
          role: {{ default "blah" $glyphDefinition.provider.vault.auth.kubernetes.role }} #TODO

          {{- if $glyphDefinition.provider.vault.auth.kubernetes.serviceAccountRef }} #SA with ref 
          serviceAccountRef:
            name: {{ $glyphDefinition.provider.vault.auth.kubernetes.serviceAccountRef.name }}
            namespace: {{ $glyphDefinition.provider.vault.auth.kubernetes.serviceAccountRef.namespace }}
          {{- end }}

          {{- if $glyphDefinition.provider.vault.auth.kubernetes.secretRef }} #SA JWT
          secretRef:
            name: {{ $glyphDefinition.provider.vault.auth.kubernetes.secretRef.name }}
            namespace: {{ $glyphDefinition.provider.vault.auth.kubernetes.secretRef.namespace }}
            key: {{ $glyphDefinition.provider.vault.auth.kubernetes.secretRef.key }}
          {{- end }}
        {{- end }}
  {{- end }}
{{- end }}
