{{/*kast - Kubernetes arcane spelling technology
Copyright (C) 2025 laaledesiempre@disroot.org
Licensed under the GNU GPL v3. See LICENSE file for details.
*/}}
{{- define "externalsecrets.secret-store" }}
{{- $root := index . 0 -}}
{{- $glyphDefinition := index . 1}}

{{- /* Find provider servers via runic indexer */ -}}
{{- $providerType := $glyphDefinition.provider.type }}
{{- $providerServers := get (include "runicIndexer.runicIndexer" (list $root.Values.lexicon (default dict $glyphDefinition.provider.selector) $providerType $root.Values.chapter.name ) | fromJson) "results" }}

{{- /* For non-vault providers, we may not need servers from lexicon */ -}}
{{- if eq (len $providerServers) 0 }}
  {{- /* Create dummy server for providers that don't use lexicon */ -}}
  {{- $providerServers = list (dict) }}
{{- end }}

{{- range $providerServer := $providerServers }}
---
apiVersion: external-secrets.io/v1alpha1
kind: {{ default "" $glyphDefinition.mode | title }}SecretStore
metadata:
  name: {{ default (include "common.name" $root ) $glyphDefinition.name }}
spec:
  provider:
  {{- if eq $providerType "vault" }}
    {{- /* Vault provider */ -}}
    vault:
      version: v2
      server: {{ default $providerServer.url ($glyphDefinition.provider.config).server }}
      path: {{ default $providerServer.secretPath ($glyphDefinition.provider.config).path }}
      auth:
        {{- if ($glyphDefinition.provider.config).auth.tokenSecretRef }}
        tokenSecretRef:
          key: {{ ($glyphDefinition.provider.config).auth.tokenSecretRef.key }}
          name: {{ ($glyphDefinition.provider.config).auth.tokenSecretRef.name }}
          namespace: {{ ($glyphDefinition.provider.config).auth.tokenSecretRef.namespace }}
        {{- else }}
        kubernetes:
          mountPath: {{ default $providerServer.authPath ($glyphDefinition.provider.config).auth.kubernetes.mountPath }}
          role: {{ default (include "common.name" $root) ($glyphDefinition.provider.config).auth.kubernetes.role }}

          {{- if ($glyphDefinition.provider.config).auth.kubernetes.serviceAccountRef }}
          serviceAccountRef:
            name: {{ ($glyphDefinition.provider.config).auth.kubernetes.serviceAccountRef.name }}
            namespace: {{ ($glyphDefinition.provider.config).auth.kubernetes.serviceAccountRef.namespace }}
          {{- end }}

          {{- if ($glyphDefinition.provider.config).auth.kubernetes.secretRef }}
          secretRef:
            name: {{ ($glyphDefinition.provider.config).auth.kubernetes.secretRef.name }}
            namespace: {{ ($glyphDefinition.provider.config).auth.kubernetes.secretRef.namespace }}
            key: {{ ($glyphDefinition.provider.config).auth.kubernetes.secretRef.key }}
          {{- end }}
        {{- end }}

  {{- else if eq $providerType "aws" }}
    {{- /* AWS Secrets Manager provider - IRSA via kSA */ -}}
    aws:
      service: {{ default "SecretsManager" ($glyphDefinition.provider.config).service }}
      region: {{ required "AWS provider requires config.region" ($glyphDefinition.provider.config).region }}
      auth:
        jwt:
          serviceAccountRef:
            name: {{ required "AWS provider requires config.serviceAccount.name" ($glyphDefinition.provider.config).serviceAccount.name }}
            {{- with ($glyphDefinition.provider.config).serviceAccount.namespace }}
            namespace: {{ . }}
            {{- end }}

  {{- else if eq $providerType "gcp" }}
    {{- /* GCP Secret Manager provider - Workload Identity via kSA */ -}}
    gcpsm:
      projectID: {{ required "GCP provider requires config.projectID" ($glyphDefinition.provider.config).projectID }}
      auth:
        workloadIdentity:
          {{- with ($glyphDefinition.provider.config).clusterLocation }}
          clusterLocation: {{ . }}
          {{- end }}
          {{- with ($glyphDefinition.provider.config).clusterName }}
          clusterName: {{ . }}
          {{- end }}
          serviceAccountRef:
            name: {{ required "GCP provider requires config.serviceAccount.name" ($glyphDefinition.provider.config).serviceAccount.name }}
            {{- with ($glyphDefinition.provider.config).serviceAccount.namespace }}
            namespace: {{ . }}
            {{- end }}

  {{- else }}
    {{- fail (printf "Unsupported provider type: %s. Supported types: vault, aws, gcp" $providerType) }}
  {{- end }}
{{- end }}
{{- end }}
