# Test example for Vault database dynamic credentials consumption
# Shows how applications consume dynamic credentials generated by postgresqlDBEngine

name: database-credentials-test

chapter:
  name: base-system

spellbook:
  name: test-book

lexicon:
  # Vault server
  - chapter: base-system
    type: vault
    url: http://vault.vault.svc:8200
    namespace: vault
    serviceAccount: vault
    authPath: the-yaml-life
    secretPath: secret
    labels:
      default: book

  # PostgreSQL server with Vault credentials
  - chapter: base-system
    type: postgres
    name: main-postgres
    host: postgres.database.svc.cluster.local
    port: 5432
    database: postgres
    vaultSecretPath: "chapter"
    labels:
      app: postgres
      environment: production

glyphs:
  vault:
    # Step 1: Mount the database secrets engine
    - type: secretEngineMount
      mountType: database
      description: "Database secrets engine for dynamic PostgreSQL credentials"

    # Step 2: Configure PostgreSQL database engine
    - type: postgresqlDBEngine
      name: postgres-engine
      postgresSelector:
        app: postgres
      serviceAccount: vault

    # Step 3: Create policies for applications to access database credentials
    # This will auto-generate policy for: database-test-book-base-system/creds/*
    - type: prolicy
      name: myapp-policy
      serviceAccount: myapp

    - type: prolicy
      name: reporting-policy
      serviceAccount: reporting-app

    # Application consumes dynamic credentials
    # This VaultSecret will automatically request and renew database credentials
    - type: secret
      name: myapp-db-credentials
      generationType: "database"        # Uses database engine path
      databaseEngine: "main-postgres"   # Name from lexicon
      databaseRole: "read-write"        # or "read-only"
      path: "chapter"                   # Path scope (optional, defaults to "chapter")
      format: env                       # Environment variable format
      serviceAccount: myapp             # App's ServiceAccount
      refreshPeriod: 30m                # Refresh before TTL expires
      keys:
        - username
        - password

    # Example: read-only credentials for reporting app
    - type: secret
      name: reporting-db-credentials
      generationType: "database"
      databaseEngine: "main-postgres"
      databaseRole: "read-only"
      path: "chapter"
      format: env
      serviceAccount: reporting-app
      refreshPeriod: 45m
      keys:
        - username
        - password
