{{/*kast - Kubernetes arcane spelling technology
Copyright (C) 2025 laaledesiempre@disroot.org
Licensed under the GNU GPL v3. See LICENSE file for details.
*/}}
{{- define "external-secrets.external-secret" }}
{{- $root := index . 0 -}}
{{- $glyphDefinition := index . 1}}

{{- /* Find SecretStore via runic indexer */ -}}
{{- $secretStores := get (include "runicIndexer.runicIndexer" (list $root.Values.lexicon (default dict $glyphDefinition.selector) "secret-store" $root.Values.chapter.name ) | fromJson) "results" }}
{{- $secretStore := index $secretStores 0 }}

{{- /* Get store name and kind from found store */ -}}
{{- $storeName := default (include "common.name" $root) $secretStore.name }}
{{- $storeKind := "SecretStore" }}
{{- if eq $secretStore.mode "cluster" }}
  {{- $storeKind = "ClusterSecretStore" }}
{{- end }}

{{- /* Determine provider type from labels or default to vault */ -}}
{{- $providerType := "vault" }}
{{- if $secretStore.labels }}
  {{- if $secretStore.labels.provider }}
    {{- $providerType = $secretStore.labels.provider }}
  {{- end }}
{{- end }}

{{- /* Find provider server for path generation (vault only) */ -}}
{{- $providerServer := dict }}
{{- if eq $providerType "vault" }}
  {{- $vaultServers := get (include "runicIndexer.runicIndexer" (list $root.Values.lexicon (default dict $glyphDefinition.selector) "vault" $root.Values.chapter.name ) | fromJson) "results" }}
  {{- if gt (len $vaultServers) 0 }}
    {{- $providerServer = index $vaultServers 0 }}
  {{- end }}
{{- end }}
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ $glyphDefinition.name }}
{{- with $glyphDefinition.labels }}
  labels:
    {{- toYaml . | nindent 4 }}
{{- end }}
{{- with $glyphDefinition.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
{{- end }}

spec:
  secretStoreRef:
    name: {{ $storeName }}
    kind: {{ $storeKind }}
  refreshPolicy: {{ default "Periodic" $glyphDefinition.refreshPolicy }}
  refreshInterval: {{ default "30m" $glyphDefinition.refreshInterval}}
  target:
    name: {{ $glyphDefinition.name }}
    creationPolicy: {{ default "Orphan" $glyphDefinition.creationPolicy }}
    deletionPolicy: {{ default "Merge" $glyphDefinition.deletionPolicy }}
  {{- if $glyphDefinition.template }}
  {{- with $glyphDefinition.template }}
    template:
      {{- with .type }}
      type: {{ . }}
      {{- end }}
      {{- with .metadata }}
      metadata:
        {{- with .labels }}
        labels:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        {{- with .annotations }}
        annotations:
          {{- toYaml . | nindent 10 }}
        {{- end }}
      {{- end }}
      {{- with .data }}
      data:
      {{- toYaml . | nindent 8 }}
      {{- end }}
  {{- end }}

  {{- with $glyphDefinition.data }}
  data:
    {{- range . }}
    - secretKey: {{ .secretKey }}
      remoteRef:
        {{- if (.remoteRef).key }}
        key: {{ (.remoteRef).key }}
        {{- else if eq $providerType "vault" }}
        key: {{ include "vault.secretPath" ( list $root $glyphDefinition $providerServer dict ) }}
        {{- else }}
        key: {{ include "common.secretPath" ( list $root $glyphDefinition "" dict ) }}
        {{- end }}
        property: {{ default .secretKey (.remoteRef).property }}
    {{- end }}
  {{- end }}
  {{- else if $glyphDefinition.dataFrom }}
  dataFrom:
  {{- $glyphDefinition.dataFrom | toYaml | nindent 2 }}
  {{- else }}
  dataFrom:
    {{- if eq $providerType "vault" }}
    - key: {{ include "vault.secretPath" ( list $root $glyphDefinition $providerServer dict ) }}
    {{- else }}
    - key: {{ include "common.secretPath" ( list $root $glyphDefinition "" dict ) }}
    {{- end }}
    {{- end }}
{{- end }}
