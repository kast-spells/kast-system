{{/*kast - Kubernetes arcane spelling technology
Copyright (C) 2025 laaledesiempre@disroot.org
Licensed under the GNU GPL v3. See LICENSE file for details.
*/}}
{{- define "external-secrets.push-secret" }}
{{- $root := index . 0 -}}
{{- $glyphDefinition := index . 1}}

{{- /* Find SecretStore via runic indexer */ -}}
{{- $secretStores := get (include "runicIndexer.runicIndexer" (list $root.Values.lexicon (default dict $glyphDefinition.selector) "secret-store" $root.Values.chapter.name ) | fromJson) "results" }}
{{- $secretStore := index $secretStores 0 }}

{{- /* Determine provider type from labels or default to vault */ -}}
{{- $providerType := default "vault" $secretStore.provider }}

{{- /* Find provider server for path generation (vault only) */ -}}
{{- $providerServer := dict }}
{{- if eq $providerType "vault" }}
  {{- $vaultServers := get (include "runicIndexer.runicIndexer" (list $root.Values.lexicon (default dict $glyphDefinition.selector) "vault" $root.Values.chapter.name ) | fromJson) "results" }}
  {{- if gt (len $vaultServers) 0 }}
    {{- $providerServer = index $vaultServers 0 }}
  {{- end }}
{{- end }}

---
apiVersion: generators.external-secrets.io/v1alpha1
kind: Password 
metadata:
  name: {{ $glyphDefinition.name }}
spec:  
  length: {{ default "32" ($glyphDefinition.password).length }}
  digits: {{ default "5" ($glyphDefinition.password).digits }}
  symbols: {{ default "5" ($glyphDefinition.password).symbols }}
  symbolCharacters: {{ default "-_@" ($glyphDefinition.password).symbolCharacters }}
  allowRepeat: {{ default "true" ($glyphDefinition.password).repeat }}
---
apiVersion: external-secrets.io/v1alpha1
kind: {{ default "" $glyphDefinition.mode | title }}PushSecret
metadata:
  name: {{ $glyphDefinition.name }}
  annotations:
spec:
  refreshInterval: {{ default "60m0s" $glyphDefinition.refreshInterval}}
  secretStoreRefs:
    - name: {{ default (include "common.name" $root) $secretStore.name }}          
      kind: {{ default "" $secretStore.mode | title }}SecretStore
  selector:
    generatorRef:
      apiVersion: generators.external-secrets.io/v1alpha1
      kind: Password
      name: {{ $glyphDefinition.name }}
  
  data: 
    - match:
        secretKey: {{ default "password" $glyphDefinition.randomKey }}
        remoteRef:
          {{- if $glyphDefinition.path }}
          remoteKey: {{ $glyphDefinition.path }}
          {{- else if eq $providerType "vault" }}
          remoteKey: {{ include "vault.secretPath" ( list $root $glyphDefinition $providerServer dict ) }}
          {{- else if eq $providerType "aws" }}
          remoteKey: {{ include "aws.secretPath" ( list $root $glyphDefinition dict ) }}
          {{- else if eq $providerType "gcp" }}
          remoteKey: {{ include "gcp.secretPath" ( list $root $glyphDefinition dict ) }}
          {{- else }}
          remoteKey: {{ include "common.secretPath" ( list $root $glyphDefinition "" dict ) }}
          {{- end }}
  {{- end}}