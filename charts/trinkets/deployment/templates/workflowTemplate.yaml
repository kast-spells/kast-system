 {{/*kast - Kubernetes arcane spelling technology
Copyright (C) 2023 namenmalkv@gmail.com
Licensed under the GNU GPL v3. See LICENSE file for details.
 */}}
{{- $root := . }}{{/* esto seria remplazable por $ pero para lectura de codigo */}} 

{{- if $root.Values.sentence.enabled }}
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: {{ $root.Values.name }}-{{ $root.Values.serviceAccount.name }}-template
spec:
  entrypoint: deploy
  arguments:
    parameters:
    {{- range $root.Values.parameters }}
      {{-  . | toYaml| nindent 6 }}
    {{- end }}
  templates:
    - name: deploy
      volumes:
      {{- range $cantrip := $root.Values.sentence.cantrips }}
      {{- include "summon.common.volumes" $root | nindent 8}}
      {{- end}}
        - name: repo-volume
          emptyDir:
            sizeLimit: 1Gi
        - name: ssh-key-volume
          secret:
            secretName: kast01-ssh
            defaultMode: 0600
      containerSet:
        volumeMounts:
          - name: repo-volume
            mountPath: /repo
        containers:
        {{- range $cantripName, $cantrip := $root.Values.sentence.cantrips }}
          {{- if $cantrip.verb }}
          {{- $content := include (printf "default-verbs.%s" $cantrip.verb ) (list $root $cantripName $cantrip ) }}
          {{ tpl $content $ }}
            {{- include (printf "default-verbs.%s" $cantrip.verb ) (list $root $cantripName $cantrip ) | tpl | nindent 8 }}
            {{- include "summon.common.container" (list $root $cantripName $cantrip ) | toYaml | nindent 8 }}
          {{ else }}
            {{- include "summon.common.container" (list $root $cantripName $cantrip ) | nindent 8 }}
          {{- end }}
          {{- with $cantrip.dependencies }}
          dependencies:
            - {{ . }}
          {{- end }}
        {{- end }}
        - name: container-build
          image: noenv/buildah
          command: [sh, -c]
          env:
            - name: REGISTRY_PASS
              valueFrom:
                secretKeyRef:
                  name: harbor-creds
                  key: password
            - name: REGISTRY_USER
              valueFrom:
                secretKeyRef:
                  name: harbor-creds
                  key: user
            - name: REGISTRY_HOST
              valueFrom:
                secretKeyRef:
                  name: harbor-creds
                  key: host
{{- end }}
