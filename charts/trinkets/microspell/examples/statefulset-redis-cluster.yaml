# StatefulSet Redis Cluster Example
# Shows how to use microspell for stateful services with vault secrets

spellbook:
  name: example-tdd-book
chapter:
  name: infrastructure

lexicon:
  - chapter: infrastructure
    skipVerify: true
    type: vault
    url: http://vault.vault.svc:8200
    namespace: vault
    serviceAccount: vault
    authPath: k8s-path-auth
    secretPath: kv
    labels:
      default: book

name: redis-cluster

image:
  name: redis
  tag: "7.0-alpine"
  pullPolicy: IfNotPresent

# StatefulSet workload configuration
workload:
  enabled: true
  type: statefulset
  replicas: 3

# Service for StatefulSet
service:
  enabled: true
  type: ClusterIP
  ports:
    - port: 6379
      name: redis
    - port: 16379
      name: cluster-bus

# Environment variables
envs:
  REDIS_MODE: cluster
  CLUSTER_ENABLED: "yes"
  LOG_LEVEL: notice

# Vault secrets for Redis cluster
secrets:
  # Redis cluster configuration via envFrom
  cluster-config:
    location: vault
    path: chapter
    private: redis-cluster
    format: env
    keys:
      - cluster-announce-ip
      - cluster-announce-port
      - cluster-bus-port
    staticData:
      cluster-config-file: "nodes.conf"
      cluster-node-timeout: "15000"
      
  # Authentication secrets
  auth-config:
    location: vault
    path: book
    private: redis-auth
    format: env
    keys:
      - redis-password
      - admin-password
    staticData:
      protected-mode: "yes"
      requirepass-enabled: "true"

# Additional volumes for StatefulSet (non-persistent)
volumes:
  # Persistent data volume for StatefulSet
  data:
    type: claimTemplates
    destinationPath: /data
    storageClassName: fast-ssd
    size: 10Gi
    accessMode: ReadWriteOnce
  config:
    type: emptyDir
    destinationPath: /etc/redis
    size: 100Mi
  logs:
    type: emptyDir
    destinationPath: /var/log/redis
    size: 500Mi

# Service account
serviceAccount:
  enabled: true

# Note: StatefulSet persistent storage configured via workload.volumeClaimTemplates above
# Additional volumes above are for temporary/config data

# Resource limits for Redis
resources:
  limits:
    cpu: 1000m
    memory: 2Gi
  requests:
    cpu: 500m
    memory: 1Gi