# Microspell with Managed PostgreSQL
# Creates new CNPG cluster with Vault DB Engine integration
# App uses dynamic credentials

name: psql-managed-test

# Chapter and spellbook context
chapter:
  name: test-chapter
spellbook:
  name: test-book

# Lexicon with Vault server
lexicon:
  - type: vault
    url: http://vault.vault.svc:8200
    namespace: vault
    serviceAccount: vault
    authPath: test-book
    secretPath: secret
    labels:
      default: book

# Basic microservice
image:
  repository: postgres
  tag: "16-alpine"

command:
  - sleep
  - infinity

# PostgreSQL DataStore (MANAGED)
dataStore:
  psql:
    enabled: true
    # No selector â†’ Creates new cluster

    cluster:
      instances: 2
      storage:
        size: 20Gi
      resources:
        requests:
          cpu: 500m
          memory: 1Gi
        limits:
          cpu: 2000m
          memory: 4Gi

    initDb:
      enabled: true
      sql: |
        CREATE EXTENSION IF NOT EXISTS pg_trgm;
        CREATE EXTENSION IF NOT EXISTS uuid-ossp;

        CREATE TABLE IF NOT EXISTS users (
          id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
          email VARCHAR(255) UNIQUE NOT NULL,
          created_at TIMESTAMP DEFAULT NOW()
        );

        CREATE INDEX idx_users_email ON users USING gin(email gin_trgm_ops);

    credentials:
      dynamic:
        role: read-write
        ttl: "1h"

# Service configuration
service:
  enabled: true
  ports:
    - port: 5432
      name: postgres
