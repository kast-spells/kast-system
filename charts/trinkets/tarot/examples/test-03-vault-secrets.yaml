name: test-03-vault-secrets

spellbook: {name: test}
chapter: {name: advanced}

# Lexicon with vault server
lexicon:
  - name: test-vault
    type: vault
    labels: {default: book}
    server: vault.vault.svc.cluster.local:8200
    secretPath: secret
    auth:
      kubernetes:
        path: kubernetes
        role: test-vault-role

cards:
  - name: vault-consumer
    type: card
    labels: {category: vault-test}
    container:
      image: alpine:latest
      command: ["sh", "-c"]
      args: ["env | grep -E '(DOCKER|API|DB)' | sort"]

tarot:
  executionMode: container

  # Unified secrets - K8s and Vault
  secrets:
    # K8s Secret
    app-config:
      contentType: env
      content:
        APP_MODE: "production"
        LOG_LEVEL: "info"

    # Vault Secret with keys
    docker-creds:
      location: vault
      path: chapter
      format: env
      keys: [DOCKER_USER, DOCKER_PASS]

    # Vault Secret with random
    api-token:
      location: vault
      path: chapter
      random: true
      randomKey: API_SECRET

    # Vault with static data
    db-config:
      location: vault
      path: chapter
      format: env
      keys: [DB_PASSWORD]
      staticData:
        DB_HOST: "postgres.default.svc"
        DB_PORT: "5432"

  # ConfigMaps
  configMaps:
    app-settings:
      contentType: file
      content: |
        setting1=value1
        setting2=value2

  # Volumes
  volumes:
    data:
      type: emptyDir
      sizeLimit: 2Gi

  # Envs
  envs:
    ENVIRONMENT: "advanced-test"
    CLUSTER_NAME: "test-cluster"

  reading:
    consume:
      selectors: {category: vault-test}
      position: foundation

  serviceAccount:
    enabled: true
    name: vault-test-runner
    annotations:
      vault.hashicorp.com/role: "test-vault-role"

  rbac:
    enabled: true

  generateName: true
